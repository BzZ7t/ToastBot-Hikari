#
#
#
#    NOT CURRENTLY CONFIDENT THIS WORKS
#       I got lazy and used chatGPT 
#
#

import json
import random

import hikari
import lightbulb

plugin = lightbulb.Plugin('level')

level_file = 'plugins/assets/level/levels.json'

def load_user_levels(self):
    try:
        with open(level_file, "r") as file:
            self.user_levels.update(json.load(file))
    except FileNotFoundError:
        print(f"{level_file} not found. Starting with an empty user_levels dictionary.")

def save_user_levels(self):
    with open(level_file, "w") as file:
        json.dump(self.user_levels, file, indent=4)

@plugin.listener(hikari.StartingEvent)
async def on_starting(self, event: hikari.StartingEvent):
    self.load_user_levels()

@plugin.listener(hikari.StoppingEvent)
async def on_stopping(self, event: hikari.StoppingEvent):
    self.save_user_levels()

@plugin.listener(hikari.GuildMessageCreateEvent)
async def on_message_create(self, event: hikari.GuildMessageCreateEvent):
    message = event.message
    author = message.author

    if author.is_bot:
        return

    if author.id not in self.user_levels:
        self.user_levels[author.id] = 0

    if random.random() < 0.1:  # Adjust the probability as desired
        self.user_levels[author.id] += 1
        level_message = f"Congratulations {author.mention}! You leveled up to level {self.user_levels[author.id]}!"
        await message.respond(level_message)

@plugin.command
@lightbulb.option('user',
                  "check another user's level",
                  required=False,
                  default="")
@lightbulb.command('level',
                   "check your, or another user's level")
async def level(self, ctx):
    author = ctx.author.id

    if author.id in self.user_levels:
        current_level = self.user_levels[author]
        level_message = f"{author.mention}, your current level is {current_level}."
        await ctx.respond(level_message)
    else:
        await ctx.respond("You haven't earned any levels yet.")

def load(bot):
    bot.add_plugin(plugin)